{% load main_app_extras %}
{% load humanize %}
<!doctype html>
<html lang="pt-br">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<style id="wait">
			body {
				visibility: hidden;
				opacity: 0;
			}
		</style>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css">
		<script src="/static/js/cookieman.js?v=1"></script>
		<link rel="stylesheet" href="/static/css/common.min.css">
		<script>
			var cssfn = 'light.css';
			var cssversion = '?v=5';
			if (getDarkCookie() == 'true') { cssfn = 'dark.css'; }
			var link = document.createElement('link');
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = '/static/css/' + cssfn + cssversion;
			document.head.appendChild(link);

			document.getElementById('wait').remove();
		</script>
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
		<script src="https://kit.fontawesome.com/1f965a8b94.js"></script>
		<title>{{ question.text }} | Asker</title>
		
		<script>
			csrf_token = "{{ csrf_token }}";
		</script>
	</head>
	<body>

		{% include "includes/navbar.html" %}

<br>
		<main>
			<div class="card bg-main">
				<div class="card-body">
					
					<div class="poster-container">
						<a class="poster-info" href="/user/{{ question.creator.user.username }}">
							<div class="poster-profile-pic-container">
								<img title="{{ question.creator.user.username }}" class="poster-profile-pic-popover" src="{{ question.creator.avatar.url }}" alt="{{ question.creator.user.username }}">
							</div>
							<div class="poster-text-container">
								<div>
									<span>{{ question.creator.user.username }}</span>
									<br>
									<span title="{{ question.pub_date }}" class="post-pub-date">{% fix_naturaltime question.pub_date|naturaltime %}</span>
								</div>
							</div>
						</a>
					</div>
					
					<h1 style="font-size: 1.4em; font-weight: 500;">{{ question.text }}</h1>
					
					{% if question.description %}
						<div>
							<hr>
							<p class="description">{{ question.description|linebreaksbr }}</p>
						</div>
					{% endif %}

					{% if question.get_embedded_content %}
						<div class="emb">
							{{ question.get_embedded_content|safe }}
						</div>
						<br>
					{% endif %}

					{% if question.image %}
						<div>
							<hr>
							<img style="display: block; margin-left: auto; margin-right: auto;" width="70%" src="{{ question.image.url }}">
							<br>
						</div>
					{% endif %}

					{% if question.has_poll %}
						{% voted user poll as VOTED %}
						{% if not VOTED and poll.may_vote and user.is_authenticated %}
							<div class="card poll poll-chooser bg-inner">
								<ul class="list-group list-group-flush">
								{% for choice in poll_choices %}
									<li class="choice list-group-item bg-inner-when-dark">
										<div class="chooser">
											<label>
												{% if poll.multichoice %}
													<input class="poll-option" type="checkbox" name="poll-option" value="{{ choice.id }}">
												{% else %}
													<input class="poll-option" type="radio" name="poll-option" value="{{ choice.id }}">
												{% endif %}
												<span class="left-spaced">{{ choice.text }}</span>
											</label>
										</div>
									</li>
								{% endfor %}
								</ul>
								<div class="card-footer">
									<button class="btn btn-primary" onclick="voteOnPoll();" >Votar</button>
									<span class="clickable left-spaced" onclick="openShower();">Ver resultados</span>
								</div>
							</div>
						{% endif %}

						<div class="card poll-shower bg-inner"><div class="card-body">
							<input type="hidden" name="qpoll" value="{{ poll.id }}">
							{% for choice in poll_choices %}
								<div class="choice-show">

									{% if user|has_chosen:choice %}
									<span class="float-right">
										<span class="vote-count">{{ choice.votes }}</span> votos
										<i class="fa fa-check-circle-o" aria-hidden="true"></i> </span>
									{% else %}
									<span class="float-right"><span class="vote-count">{{ choice.votes }}</span> votos</span>
									{% endif %}

									<span>{{ choice.text }}</span>

									<div class="progress progress-striped active">
										<div class="progress-bar progress-bar-primary" style="width: 0%;"></div>
									</div>
								</div>
							{% endfor %}

						</div>
							<div class="card-footer">
							{% if poll.may_vote %}
								{% if not VOTED and user.is_authenticated %}
									<span class="clickable left-spaced" onclick="openChooser();">Votar</span>
								{% elif user.is_authenticated %}
									<span class="clickable left-spaced" onclick="undoVote();">Retirar voto</span>
								{% else %}
									<span>Fa√ßa login ou crie uma conta para responder √† enquete.</span>
								{% endif %}
							{% else %}
								<span>Vota√ß√£o encerrada.</span>
							{% endif %}
							</div>
						</div>
					{% endif %}

					{% if question.creator.user.username == user.username %}
						<form method="post" action="/delete_question" onsubmit="if(confirm('Opa! Tem certeza que deseja apagar sua resposta?')) return true; else return false;">
							{% csrf_token %}
							<input type="hidden" name="question_id" 
value="{{ question.id }}">
				                        <button class="btn 
btn-outline-danger">Apagar</button>
						</form>
					{% endif %}
                    
                    {% if user.is_authenticated and question.creator.id != user.id %}
                        <hr>
                        <i class="far fa-flag" data-toggle="popover" title="Reportar Pergunta?" data-content="<button class='btn btn-danger btn-sm' onclick='report_question({{ question.id }});'>Reportar Pergunta</button>" data-html="true"></i>
                    {% endif %}
                    {% if 'pap' in user_permissions %}
                        <form method="post" action="/delete_question" onsubmit="if(confirm('Apagar pergunta?')) return true; else return false;">
                            {% csrf_token %}
                            <input type="hidden" name="question_id" value="{{ question.id }}">
                            <button class="btn btn-outline-info btn-sm">Deletar</button>
                        </form>
                    {% endif %}
				</div>
			</div>

            {% if user.is_anonymous %}
                <div class="text-center bg-light" style="margin: 15px">
                    Fa√ßa <a href="/signin?redirect=/question/{{ question.id }}">login</a> ou <a 
href="/signup?redirect=/question/{{ question.id }}">crie uma conta</a> para responder essa pergunta.
                </div>
            {% endif %}

<br>
<div class="card-header" style="background: transparent; border: none;">				
    	  <span id="total-de-respostas" style="color: #DA70D6; font-weight: 900; font-size: 20px;"></span>
          <span id="total-de-respostas-sentence" style="color: #00CED1; font-weight: 600; font-size: 14px;">
          </span> üí¨
                    {% answered user question.id as USER_ANSWER %}
                    {% if user.is_authenticated and not USER_ANSWER %}
                        <div style="float: right; cursor: pointer;" id="Responder" onclick="location.href = '#sua-resposta'">
                            <i class="fas fa-pen"></i>
                        </div>
                    {% endif %}
</div>
<br> 				
  				
			<section class="card bg-main" id="responses">
  								
				<ul class="list-group list-group-flush responses">
				{% for response in responses|pull_best_answer %}
					{% if response.creator.user not in user_p.silenced_users.all or request.user.is_anonymous %}
						{% include "base/response-content.html" %}
					{% endif %}
				{% endfor %}
				</ul>
			</section>
			
			
			{% if user.is_authenticated %}
				{% if user_p.active %}
					{% answered user.username question.id as ANSWERED %}
					{% if not ANSWERED %}
						{% ablockb question.creator.user.username user.username as BLOCKED %}
						{% if not BLOCKED %}
							<form id="formulario_de_resposta">
								{% csrf_token %}
								<input type="hidden" name="question_id" value="{{ question.id }}">
								
	 <br>
	 
  <textarea id="sua-resposta" maxlength="5000" class="form-control large-compact" placeholder="Sua Resposta:" name="text" required="required" onclick="$(this).css('height', '140px')"></textarea><br>
								
	<button class="btn btn-outline-primary" type="submit" style="border-radius: 30px" id="botao_enviar_resposta">
		<i class="far fa-paper-plane"></i>
		Enviar
        </button>
								
								<label for="upload-photo">
									&nbsp;<i class="fas fa-camera fa-lg"></i>
									<span id="upload-photo-text"></span>
								</label>
								
								<input type="file" accept="image/*" name="file" id="upload-photo" onclick="return veracity_test({{ user_p.total_points }}, {% MINIMUM_POINTS_FOR_POSTING_IMAGES %});">
								<img src="/static/images/close-icon.png" width="20px" style="display: none; cursor: pointer;" id="delete-photo-icon">
							</form>
							<img src="/static/images/loading.gif" width="30px" style="display: none;" id="response-loading-gif">
						{% else %}
							Pergunta Indispon√≠vel.
						{% endif %}
					{% endif %}
				{% endif %}
			{% endif %}
            
            {% if user.is_anonymous %}
                <div class="text-center bg-light" style="margin: 15px">
                    Fa√ßa <a href="/signin?redirect=/question/{{ question.id }}">login</a> ou <a 
href="/signup?redirect=/question/{{ question.id }}">crie uma conta</a> para responder essa pergunta.
                </div>
            {% endif %}
	</main>
	<br><br>
        <script src="https://cdn.jsdelivr.net/npm/linkifyjs@2.1.9/dist/linkify.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/linkifyjs@2.1.9/dist/linkify-jquery.min.js"></script>
		<script src="/static/js/general_functions.js?version=3"></script>
		<script src="/static/js/question.min.js?v=1.1"></script>
        <script>
            $('.description').linkify();
        </script>
<script>
    /* Calcula e mostra o total de respostas da pergunta. */
    respostas = document.getElementsByClassName('resposta');
    document.getElementById('total-de-respostas').innerText = respostas.length;
    document.getElementById('total-de-respostas-sentence').innerText = (respostas.length == 1 ? 'Resposta' : 'Respostas');
</script>
<script>
$(function () {
    $('[data-toggle="popover"]').popover();
});

function report_question(id) {
    var report = confirm('Voc√™ tem certeza de que deseja reportar esta pergunta?');
    
    if (report) {
        $.ajax({
            url: '/report?type=q&obj_id=' + id,
            type: 'post',
            data: {
                csrfmiddlewaretoken: csrf_token,
            },
            complete: function () {
                alert('Pergunta Reportada.');
            }
        });
    }
}
</script>
	</body>
</html>
