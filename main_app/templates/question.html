{% load main_app_extras %}
{% load humanize %}
<!doctype html>
<html lang="pt-br">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<style id="wait">
			body {
				visibility: hidden;
				opacity: 0;
			}
		</style>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css">
	    <meta name="theme-color" content="#68228B" />
        <meta name="apple-mobile-web-app-status-bar-style" content="#68228B" />
	    <meta name="msapplication-navbutton-color" content="#68228B" />
		{% include "includes/themehandler.html" %}
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
		<script src="https://kit.fontawesome.com/1f965a8b94.js"></script>
		<title>{{ question.text }} | Asker</title>
		
		<script>
			csrf_token = "{{ csrf_token }}";
		</script>
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script> 
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    
	</head>
	<body>

    
    
    {% if not user.is_authenticated %}
    
     <div class="containerem" style="z-index: 9999;">
	   <div class="navegacao" style="position: fixed; padding: 10px; margin-top: 20px; padding-top: 10px; padding-bottom: 6px; background-image: linear-gradient(to right, #FF1493, #8A2BE2); height: 75px; top: -25px; border-radius: 0px 0px 20px 20px">
           
       <center> <img width="80px" src="https://i.imgur.com/2F4x4ch.png"></img> </center> 
       
       <a id="botao-popular" style="font-weight: 700; font-size: 15px; text-decoration: none; color: white; outline: none" href="/signin?redirect={{ request.get_full_path }}">Login &#10152;</a>
       
     </div>
    </div>
	{% endif %}
    
    
    
    
    {% if user.is_authenticated %}
	    {% include "includes/menubar.html" %}
    {% endif %}


	<div style="display: none">
    {% include "includes/navbar.html" %}
    </div>
    
    
  
 
    
<br><br>
		<main>
			<div class="card bg-main" style="border: none;">
				<div class="card-body" style="border: none;">
					
					<div class="poster-container">
						<a class="poster-info" href="/user/{{ question.creator.user.username }}">
							<div class="poster-profile-pic-container">
								<div style='width: 61px; height: 60px; border-radius: 100px; background: url("{{ question.creator.avatar.url }}"); background-size: cover; background-repeat: no-repeat; background-position: center' class="poster-profile-pic-popover" alt="{{ question.creator.user.username }}"></div>
							</div>
							<div class="poster-text-container" style="padding-left: 10px;">
								<div>
									<span>{{ question.creator.user.username }}</span>
									<br>
									<span title="{{ question.pub_date }}" class="post-pub-date">{% fix_naturaltime question.pub_date|naturaltime %}</span>
								</div>
							</div>
						</a>
					</div>
					
					<h1 style="font-size: 1.3em; font-weight: 700;">{{ question.text }}</h1>
					
					{% if question.description %}
						<div>
							<hr>
							<p class="description">{{ question.description|linebreaksbr }}</p>
						</div>
					{% endif %}

					{% if question.get_embedded_content %}
						<div class="emb">
							{{ question.get_embedded_content|safe }}
						</div>
						<br>
					{% endif %}

					{% if question.image %}
						<div>
                            <br>
							<img style="display: block; border-radius: 10px; margin-left: auto; margin-right: auto;" width="75%" src="{{ question.image.url }}">
							<br>
						</div>
					{% endif %}

					{% starred user question as STARRED %}
					{% if question.has_poll %}
						{% voted user poll as VOTED %}
						{% if not VOTED and poll.may_vote and user.is_authenticated %}
							<div class="card poll poll-chooser bg-inner">
								<ul class="list-group list-group-flush">
								{% for choice in poll_choices %}
									<li class="choice list-group-item bg-inner-when-dark">
										<div class="chooser">
											<label>
												{% if poll.multichoice %}
													<input class="poll-option" type="checkbox" name="poll-option" value="{{ choice.id }}">
												{% else %}
													<input class="poll-option" type="radio" name="poll-option" value="{{ choice.id }}">
												{% endif %}
												<span class="left-spaced">{{ choice.text }}</span>
											</label>
										</div>
									</li>
								{% endfor %}
								</ul>
								<div class="card-footer">
									<button class="btn btn-primary" onclick="voteOnPoll();" >Votar</button>
									<span class="clickable left-spaced" onclick="openShower();">Ver Resultados</span>
								</div>
							</div>
						{% endif %}

						<div class="card poll-shower bg-inner"><div class="card-body">
							<input type="hidden" name="qpoll" value="{{ poll.id }}">
							{% for choice in poll_choices %}
								<div class="choice-show">

									{% if user|has_chosen:choice %}
									<span class="float-right">
										<span class="vote-count">{{ choice.votes }}</span> votos
										<i class="fa fa-check-circle-o" aria-hidden="true"></i> </span>
									{% else %}
									<span class="float-right"><span class="vote-count">{{ choice.votes }}</span> votos</span>
									{% endif %}

									<span>{{ choice.text }}</span>

									<div class="progress progress-striped active">
										<div class="progress-bar progress-bar-primary" style="width: 0%;"></div>
									</div>
								</div>
							{% endfor %}

						</div>
							<div class="card-footer">
							{% if poll.may_vote %}
								{% if not VOTED and user.is_authenticated %}
									<span class="clickable left-spaced" onclick="openChooser();">Votar</span>
								{% elif user.is_authenticated %}
									<span class="clickable left-spaced" onclick="undoVote();">Retirar Voto</span>
								{% else %}
									<span>Faça login ou crie uma conta para responder à enquete.</span>
								{% endif %}
							{% else %}
								<span>Votação encerrada.</span>
							{% endif %}
							</div>
						</div>
					{% endif %}

					<video src="{{ question.videofile.url }}" width="300" height="150" poster="teste.jpg" controls> </video>

					{% if question.creator.user.username == user.username %}
						<form method="post" action="/delete_question" onsubmit="if(confirm('Opa! Tem certeza que deseja apagar sua resposta?')) return true; else return false;">
							{% csrf_token %}
							<input type="hidden" name="question_id" value="{{ question.id }}">
				            <button class="btn btn-outline-danger" style="font-size: 11px; font-weight: 600; border-radius: 30px">Apagar Postagem</button><br><br>
						</form>
					{% endif %}

                    {% if user.is_authenticated and question.creator.user.username != user.username %}
                    <div class="vertical-spaced qctrl">
                        {% if STARRED %}
                            <a id="stqa" class="badge badge-pill badge-primary" href="javascript:void(0);" onclick="star_question(this, {{ question.id }});">
								<ion-icon class="onstar text-warning" style="font-size: 24px" name="star"></ion-icon>
								<ion-icon class="offstar hidden" style="font-size: 24px" name="star-outline"></ion-icon>
								<span class="starcount">{{ question.total_stars }}</span>
							</a> 
                        {% else %}
                            <a id="stqa" class="badge badge-pill badge-primary" href="javascript:void(0);" onclick="star_question(this, {{ question.id }});">
								<ion-icon class="onstar text-warning hidden" style="font-size: 24px" name="star"></ion-icon>
								<ion-icon class="offstar" style="font-size: 24px" name="star-outline"></ion-icon>
								<span class="starcount">{{ question.total_stars }}</span>
							</a> 
                        {% endif %}
						
                        {% if question in user_p.followed_questions.all %}
                            <a id="unfqa" class="clickable" href="javascript:void(0);" onclick="unfollow_question({{ question.id }});"><ion-icon class="text-success" style="font-size: 24px" title="Deixar de seguir pergunta" name="checkmark-circle-outline"></ion-icon></a> 
                            <a id="fqa" class="clickable hidden" href="javascript:void(0);" onclick="follow_question({{ question.id }});"><ion-icon style="font-size: 24px" title="Seguir pergunta" name="add-circle-outline"></ion-icon></a> 
                        {% else %}
                            <a id="unfqa" class="clickable hidden" href="javascript:void(0);" onclick="unfollow_question({{ question.id }});"><ion-icon class="text-success" style="font-size: 24px" title="Deixar de seguir pergunta" name="checkmark-circle-outline"></ion-icon></a> 
                            <a id="fqa" class="clickable" href="javascript:void(0);" onclick="follow_question({{ question.id }});"><ion-icon style="font-size: 24px" title="Seguir pergunta" name="add-circle-outline"></ion-icon></a> 
                        {% endif %}
						
                        <a class="clickable" href="javascript:void(0);" onclick="report_question({{ question.id }});"><ion-icon style="font-size: 24px" title="Denunciar pergunta" name="flag-outline"></ion-icon></a>             
                    </div>
                    {% endif %}
                    {% if 'pap' in user_permissions %}
                       <br>
                        <form method="post" action="/delete_question" onsubmit="if(confirm('Apagar pergunta?')) return true; else return false;">
                            {% csrf_token %}
                            <br><input type="hidden" name="question_id" value="{{ question.id }}">
                            <button class="btn btn-outline-info btn-sm" style="font-weight: 900; border-radius: 30px">Deletar</button>
                        </form>
                    {% endif %}
				</div>
			</div>

            {% if user.is_anonymous %}
                <div class="text-center bg-main" style="margin: 15px">
                    Faça <a href="/signin?redirect=/question/{{ question.id }}">login</a> ou <a 
href="/signup?redirect=/question/{{ question.id }}">crie uma conta</a> para responder essa pergunta.
                </div>
            {% endif %}


<div class="card-header" style="background: transparent; border: none;">				
    	  <span id="total-de-respostas" style="color: #DA70D6; font-weight: 900; font-size: 25px;"></span>
          <span id="total-de-respostas-sentence" style="color: #00CED1; font-weight: 600; font-size: 17px;">
          </span> 💬
                    {% answered user question.id as USER_ANSWER %}
                    {% if user.is_authenticated and not USER_ANSWER %}
                        <div style="float: right; cursor: pointer;" id="Responder" onclick="location.href = '#sua-resposta'">
                            <i class="fas fa-pen"></i>
                        </div>
                    {% endif %}
</div>
 				
  				
			<section class="card bg-main" id="responses" style="border: none;">
  								
				<ul class="list-group list-group-flush responses" style="border: none;">
				{% for response in responses|pull_best_answer %}
					{% if response.creator.user not in user_p.silenced_users.all or request.user.is_anonymous %}
						{% include "base/response-content.html" %}
					{% endif %}
				{% endfor %}
				</ul>
			</section>
			
			
			{% if user.is_authenticated %}
				{% if user_p.active %}
					{% answered user.username question.id as ANSWERED %}
					{% if not ANSWERED %}
						{% ablockb question.creator.user.username user.username as BLOCKED %}
						{% if not BLOCKED %}
							<form id="formulario_de_resposta" style="padding-left: 20px; padding-right: 20px">
								{% csrf_token %}
								<input type="hidden" name="question_id" value="{{ question.id }}">
								
	 <br>
	 
  <textarea id="sua-resposta" maxlength="5000" class="form-control large-compact" style="font-size: 13px; font-weight: 600; border-radius: 10px" placeholder="Sua Resposta:" name="text" required="required" onclick="$(this).css('height', '140px')"></textarea><br>
								
	<button class="btn btn-outline-primary" type="submit" style="font-size: 14px; font-weight: 700; border-radius: 30px" id="botao_enviar_resposta">
		<i class="far fa-paper-plane"></i>
		Enviar
        </button>
								
								<label for="upload-photo">
									&nbsp;<i class="fas fa-camera fa-lg"></i>
									<span id="upload-photo-text"></span>
								</label>
								
								<input type="file" accept="image/*" name="file" id="upload-photo" onclick="return veracity_test({{ user_p.total_points }}, {% MINIMUM_POINTS_FOR_POSTING_IMAGES %});">
								<img src="/static/images/close-icon.png" width="20px" style="display: none; cursor: pointer;" id="delete-photo-icon">
							</form>
							<img src="/static/images/loading.gif" width="30px" style="display: none;" id="response-loading-gif">
						{% else %}
							Pergunta Indisponível.
						{% endif %}
					{% endif %}
				{% endif %}
			{% endif %}
            
            {% if user.is_anonymous %}
                <div class="text-center bg-main" style="margin: 15px">
                    Faça <a href="/signin?redirect=/question/{{ question.id }}">login</a> ou <a 
href="/signup?redirect=/question/{{ question.id }}">crie uma conta</a> para responder essa pergunta.
                </div>
            {% endif %}
	</main>
	<br><br>
	    <script src="/static/js/common.js?v=1.5.1"></script>
        <script src="https://cdn.jsdelivr.net/npm/linkifyjs@2.1.9/dist/linkify.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/linkifyjs@2.1.9/dist/linkify-jquery.min.js"></script>
		<script src="/static/js/general_functions.js?version=3"></script>
		<script src="/static/js/question.js?v=2.1"></script>
        <script>
            $('.description').linkify();
        </script>
<script>
    /* Calcula e mostra o total de respostas da pergunta. */
    respostas = document.getElementsByClassName('resposta');
    document.getElementById('total-de-respostas').innerText = respostas.length;
    document.getElementById('total-de-respostas-sentence').innerText = (respostas.length == 1 ? 'Resposta' : 'Respostas');
</script>
<script>
setInterval(check_for_notifications, 51000);
$(function () {
    $('[data-toggle="popover"]').popover();
});
</script>
	</body>
</html>
